
# 実装計画書

## 1. はじめに

本ドキュメントは、これまでのアーキテクチャレビューとUI/UXレビューの結果を踏まえ、アプリケーション自動生成プラットフォームを開発するための具体的な実装計画を定義するものです。

本計画は、リスクを最小限に抑えつつ、段階的に価値を提供することを目的とし、以下の3つのフェーズで構成されます。

- **Phase 1: MVP（Minimum Viable Product）**
- **Phase 2: LLM統合**
- **Phase 3: Dify統合**

各フェーズの完了は、UI経由とCLI経由の両方でエンドツーエンド（E2E）テストが成功することによって定義されます。

## 2. 実装方針

### 2.1 段階的な実装アプローチ

プロジェクトを3つのフェーズに分割し、各フェーズで動作する成果物を段階的に構築します。

| フェーズ | 目的 | 主要な実装内容 | 完了条件 |
|:--- |:--- |:--- |:--- |
| **Phase 1: MVP** | UIベースと全体像の構築 | モックベースでの疎通確認、デモアプリのダウンロードまで | UI/CLIの両方でE2Eテストが通る |
| **Phase 2: LLM統合** | LLMとの接続 | OpenAI API等を使用したエージェント層の実装 | UI/CLIの両方でE2Eテストが通る |
| **Phase 3: Dify統合** | Difyとの接続 | Difyワークフローとナレッジベースの統合 | UI/CLIの両方でE2Eテストが通る |

### 2.2 UI/CLI両対応の設計

すべてのフェーズで、以下の2つの実行方法をサポートします。

1. **UI経由**: Webブラウザからの対話的な操作
2. **CLI経由**: コマンドラインからのスクリプト実行

このデュアルインターフェース設計により、開発中の迅速な機能テスト、CI/CDパイプラインでの自動テスト、そしてユーザーの操作方法の選択肢確保を実現します。

### 2.3 E2Eテストによる品質保証

各フェーズの完了条件として、以下のE2EテストシナリオがUI経由・CLI経由の両方で成功することを必須とします。

**E2Eテストシナリオ（全フェーズ共通）:**
1. 要件ヒアリング → UIモック生成 → 承認
2. アプリケーション設計 → コード生成
3. テストデータ生成 → E2Eテスト実行
4. パッケージ化 → ダウンロード

## 3. アーキテクチャの段階的構築

### 3.1 Phase 1: MVP（モックベース）

このフェーズでは、LLMやDifyをモックに置き換え、UIからバックエンド、そしてアプリ生成までの一連のパイプラインの疎通確認に集中します。

```
┌─────────────────────────────────────────┐
│         プラットフォームUI (React)      │
└─────────────────────────────────────────┘
              ↓ HTTP
┌─────────────────────────────────────────┐
│      プラットフォームバックエンド (FastAPI) │
│  - モックエージェント層 (固定レスポンス)   │
│  - テンプレートベースのコード生成 (Jinja2) │
│  - E2Eテストエンジン (Playwright)      │
│  - パッケージ化エンジン                │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│       生成されたデモアプリ (Dockerized)   │
└─────────────────────────────────────────┘
```

### 3.2 Phase 2: LLM統合

モックエージェント層を実際のLLMに置き換え、ユーザーの自然言語要件から動的にアプリケーションを設計・生成する「頭脳」を実装します。

```
┌─────────────────────────────────────────┐
│         プラットフォームUI (変更なし)   │
└─────────────────────────────────────────┘
              ↓ HTTP
┌─────────────────────────────────────────┐
│      プラットフォームバックエンド (FastAPI) │
│  - 実装エージェント層 (LLM使用)        │
│  - LLMベースのコード生成               │
│  - E2Eテストエンジン (Playwright)      │
│  - パッケージ化エンジン                │
└─────────────────────────────────────────┘
              ↓ OpenAI API
┌─────────────────────────────────────────┐
│          OpenAI API (GPT-4等)           │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│       生成されたデモアプリ (Dockerized)   │
└─────────────────────────────────────────┘
```

### 3.3 Phase 3: Dify統合

生成されるアプリケーションをDifyのワークフローおよびナレッジベースと接続し、実用的なビジネスロジックとデータ永続性を持たせます。

```
┌─────────────────────────────────────────┐
│         プラットフォームUI (変更なし)   │
└─────────────────────────────────────────┘
              ↓ HTTP
┌─────────────────────────────────────────┐
│      プラットフォームバックエンド (FastAPI) │
│  - 実装エージェント層 (Difyカタログ連携) │
│  - Dify統合コードの生成                │
│  - E2Eテストエンジン (Playwright)      │
│  - パッケージ化エンジン                │
└─────────────────────────────────────────┘
              ↓ OpenAI API / Dify API
┌─────────────────────────────────────────┐
│    OpenAI API & Dify Platform           │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│       生成されたデモアプリ (Dockerized)   │
│    - バックエンド: Dify連携            │
└─────────────────────────────────────────┘
```

## 4. 技術スタックと開発環境

| コンポーネント | 技術スタック |
|:--- |:--- |
| **プラットフォーム・フロントエンド** | React 18, Material-UI (MUI) v5, React Router v6 |
| **プラットフォーム・バックエンド** | Python 3.11, FastAPI, Pydantic v2 |
| **エージェント層** | LangChain, OpenAI API (Phase 2以降) |
| **E2Eテスト** | Playwright (Python) |
| **パッケージ化** | Docker, docker-compose |
| **生成されるアプリ** | React, FastAPI, Loguru, Dify API SDK (Phase 3) |

**ディレクトリ構造:**

```
project-root/
├── frontend/       # プラットフォームのフロントエンド
├── backend/        # プラットフォームのバックエンド
│   ├── app/
│   ├── cli.py      # CLIエントリーポイント
├── templates/      # 生成されるアプリのテンプレート
├── tests/          # E2Eテスト
├── output/         # 生成されたアプリの出力先
└── ...
```

## 5. 各フェーズの詳細タスクと成果物

### 5.1 Phase 1: MVP - UIベースと全体像の構築

**目的:** UIの基本骨格を構築し、LLMとDifyをモックに置き換えた状態で、アプリの要件定義から生成・ダウンロードまでの一連の流れ（疎通）を確立する。ユーザー体験の全体像を早期に確認することを最優先とする。

**主要タスク:**

| カテゴリ | タスク | 詳細 |
|:--- |:--- |:--- |
| **バックエンド (FastAPI)** | APIエンドポイントの実装 | OpenAPI (Swagger) 仕様を先に定義し、フロントエンドとのインターフェースを明確化する。 |
| | モックエージェント層の実装 | 固定のアプリケーション仕様書（JSON）を返すモックエージェントを実装する。 |
| | テンプレートベースのコード生成 | Jinja2テンプレートエンジンを用いて、あらかじめ用意したReact/FastAPIのテンプレートに値を埋め込む。 |
| | パッケージ化エンジンの実装 | 生成されたコードとDockerfileをZIPファイルに固めてダウンロード可能にする。 |
| **フロントエンド (React)** | UIコンポーネントの実装 | 7ステップの画面（統合要件ヒアリング〜完了画面）の基本コンポーネントを実装する。 |
| | 統合要件ヒアリング画面の実装 | ユーザーがプロンプトを入力し、送信ボタンを押せるUIを実装する。 |
| | 進捗表示画面の実装 | 各ステップで、進捗状況を示すシンプルなローディング画面やプログレスバーを表示する。 |
| | UIモック/完了画面の実装 | 固定のUIモック画像を表示し、承認ボタンとダウンロードボタンを実装する。 |
| **CLI** | CLIエントリーポイントの実装 | `cli.py` を作成し、`generate` コマンドを実装する。 |
| | 設定ファイル読み込み | `config.yaml` を読み込み、バックエンドの各処理を直接呼び出すロジックを実装する。 |
| **テスト** | E2Eテストのセットアップ (UI/CLI) | PlaywrightとPytestを導入し、テストの基本骨格を作成する。 |

**成果物:**

- プラットフォームのフロントエンド/バックエンドのソースコード
- CLI実行スクリプト (`cli.py`)
- UI/CLI経由のE2Eテストコード
- 生成されるデモアプリのテンプレートコード
- 開発環境構築用の `docker-compose.yml`

**完了条件:**

1.  **UI経由:** UI上で「請求書検証アプリ」の生成を指示し、最終的にアプリのDockerコンテナ（ZIP形式）がダウンロードできる。
2.  **CLI経由:** `config.yaml` を使用してCLIを実行し、`output/` ディレクトリにアプリのDockerコンテナ（ZIP形式）が生成される。
3.  ダウンロード/生成されたアプリが起動し、正常に動作する。

### 5.2 Phase 2: LLM統合

**目的:** モックエージェント層を実際のLLM（OpenAI API）に置き換え、ユーザーの自然言語指示から動的にアプリケーション仕様書を生成できるようにする。これにより、プラットフォームの「頭脳」を実装する。

**主要タスク:**

| カテゴリ | タスク | 詳細 |
|:--- |:--- |:--- |
| **バックエンド (FastAPI)** | エージェント層の実装 | アーキテクチャ設計書に基づき、4つの専門エージェントとバリデーターを実装する。 |
| | LLMによるコード生成 | LLMが生成した仕様書に基づいて動的にReact/FastAPIのコードを生成するように改良する。 |
| | エラーハンドリングの強化 | LLMからの応答が不正な形式であったり、バリデーションに失敗した場合の再試行ロジックを実装する。 |
| **フロントエンド (React)** | リアルタイム性の向上 | AIが思考中であることを示すインジケーターなどを表示し、ユーザーの待ち時間体験を改善する。 |
| **テスト** | E2Eテストの拡張 | 複数の異なる要件でE2Eテストを実行し、それぞれに応じたアプリが正しく生成されることを確認する。 |

**成果物:**

- LLMと連携するエージェント層のソースコード
- 動的なコード生成に対応した生成エンジンのソースコード
- 複数の要件に対応したE2Eテストスイート

**完了条件:**

1.  **UI経由:** UI上で「ブログ記事生成アプリ」など、MVPとは異なる要件を指示し、要件に沿ったデモアプリがダウンロードできる。
2.  **CLI経由:** 複数の異なる要件を記述した `config.yaml` を用いてCLIを実行し、それぞれに対応したデモアプリが正しく生成される。
3.  ダウンロード/生成されたアプリが、モックデータを用いて要件通りに動作する。

### 5.3 Phase 3: Dify統合

**目的:** 生成されるデモアプリのバックエンドを、実際のDifyワークフローおよびDifyナレッジベースと接続する。これにより、実用的なデータ永続化とビジネスロジックを持つアプリケーションを生成可能にする。

**主要タスク:**

| カテゴリ | タスク | 詳細 |
|:--- |:--- |:--- |
| **Difyプラットフォーム** | ワークフロー/ナレッジベースの作成 | カタログに定義されたワークフロー（`create_item`等）とナレッジベースをDify上で準備する。 |
| **バックエンド (FastAPI)** | Difyカタログ連携 | パーツ選択エージェントが、DifyからAPI経由で利用可能なワークフローのリストを取得できるようにする。 |
| | Dify連携コードの生成 | 生成されるFastAPIアプリ内に、Difyワークフロー呼び出しとナレッジベース操作のエンドポイントを自動生成する。 |
| **テスト** | 統合E2Eテストの実装 | 生成されたアプリを実際に起動し、そのアプリのUI/APIを操作してDifyとの連携（データ登録→Dify上で確認）を検証する。 |

**成果物:**

- Difyプラットフォーム上に構築されたワークフロー群
- Dify連携コードを生成するロジック
- Difyとの連携を含む、完全な統合E2Eテストスイート

**完了条件:**

1.  **UI経由:** UI上で「顧客管理アプリ」を生成・起動し、UIから新規顧客を登録すると、Difyのナレッジベースにデータが反映される。
2.  **CLI経由:** CLIで「顧客管理アプリ」を生成・起動し、API経由で新規顧客を登録すると、Difyのナレッジベースにデータが反映される。
